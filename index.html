<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RoboGrocery - Place Your Order</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: linear-gradient(120deg, #96fbc4 0%, #f9f586 100%); font-family: 'Segoe UI', Arial, sans-serif; margin:0; min-height:100vh;}
    .container { max-width: 480px; background: #fffbea; margin: 2em auto; border-radius: 18px; box-shadow: 0 3px 24px #0002; padding: 2em 1.3em; }
    h1 { text-align: center; color: #3a953a; font-size:2rem; letter-spacing:1px; margin-bottom:12px;}
    .cart { margin: 12px 0 20px 0; }
    .item-row { display: flex; align-items: center; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #f7df94;}
    .item-name { font-weight: 600; color: #396b9c;}
    .item-controls button { background: #fed24d; border: none; border-radius: 50%; width: 34px; height: 34px; font-size: 1.35rem; margin: 0 3px; transition: background 0.15s;}
    .item-controls button:hover { background: #ff9800; color: #fff;}
    .item-qty { font-size: 1.1rem; width:32px; text-align:center;}
    .input-row { margin: 18px 0;}
    .input-row label { display: block; margin-bottom:5px;}
    .input-row input, .input-row select { width:95%; padding:8px; border-radius:7px; font-size:1em; border:1.5px solid #e3e36b; }
    .order-btn { width:100%; background:#ffab00; color:#fff; font-size:1.75em; font-weight:700;
      border:none; padding:20px 0 17px 0; border-radius:12px; margin-top:28px; box-shadow:0 2px 15px #fff4, 0 2px 8px #e6b34399;
      transition: background 0.18s, transform 0.07s;}
    .order-btn:active { background:#ffb733; transform:scale(0.99);}
    .status-box { margin: 24px 0 8px 0; padding: 1.3em; border-radius: 11px; font-size:1.16em; background: #e3faf1; color: #1a2b37; box-shadow: 0 1px 6px #36ed7777;}
    .otp-box { background: #ff658e; color:#fff; border-radius:12px; font-size:2em; margin-top:22px; text-align:center; font-weight: bold; padding:17px;}
    .progress-bar {margin:22px 0 14px 0;display:flex;justify-content:space-between;}
    .progress-step {font-size:1.2em;border-radius: 9px;padding:8px 13px;background:#f7df94;color:#987700;font-weight:600;}
    .progress-step.active {background:#2ad29f;color:#fff;}
    .progress-step.done {background:#c7fab5;color:#35611c;}
    @media (max-width:490px){.container{border-radius:0;box-shadow:none;margin:0;}}
  </style>
</head>
<body>
  <div class="container">
    <h1>ü§ñüçÖ RoboGrocery</h1>
    <div class="input-row">
      <label for="custname">Your Name:</label>
      <input type="text" id="custname" maxlength="30" placeholder="Full name" autocomplete="off"/>
    </div>
    <div class="cart" id="cart">
      <!-- Cart dynamically generated -->
    </div>
    <div class="input-row">
      <label for="location">Delivery Location:</label>
      <select id="location">
        <option value="">-- Select --</option>
        <option value="Avadi Main Road">Avadi Main Road</option>
        <option value="Anna Nagar">Anna Nagar</option>
        <option value="Sembakkam">Sembakkam</option>
        <option value="Chennai Central">Chennai Central</option>
        <option value="Thirumullaivoyal">Thirumullaivoyal</option>
        <option value="Red Hills">Red Hills</option>
        <option value="Ambattur">Ambattur</option>
        <option value="Mogappair West">Mogappair West</option>
      </select>
    </div>
    <div class="input-row">
      <label for="password">Set 6-digit Password:</label>
      <input type="password" id="password" maxlength="6" pattern="[0-9]{6}" placeholder="******" autocomplete="new-password"/>
    </div>
    <button class="order-btn" onclick="placeOrder()">üõí Place Order</button>
    <div id="progress" style="display:none;"></div>
    <div id="status" style="display:none;"></div>
    <div id="otp" style="display:none;"></div>
  </div>
  <script>
    // API root
    const API = 'https://robo-backend-production-34af.up.railway.app/api';

    // Products
    let products = [
      { name: "Tomato", qty: 0 },
      { name: "Banana", qty: 0 },
      { name: "Maggie Noodles", qty: 0 },
      { name: "Onion", qty: 0 },
      { name: "Milk Packet", qty: 0 },
      { name: "Soap", qty: 0 },
      { name: "Toothpaste", qty: 0 },
      { name: "Potato", qty: 0 }
    ];

    function renderCart() {
      const cartDiv = document.getElementById("cart");
      cartDiv.innerHTML = "<b style='color:#172758'>Your Cart:</b>";
      products.forEach((p, i) => {
        cartDiv.innerHTML += `
          <div class="item-row">
            <span class="item-name">${p.name}</span>
            <div class="item-controls">
              <button onclick="addItem(${i}, -1)">-</button>
              <span class="item-qty">${p.qty}</span>
              <button onclick="addItem(${i}, 1)">+</button>
            </div>
          </div>
        `;
      });
    }
    renderCart();

    function addItem(idx, delta) {
      products[idx].qty = Math.max(0, products[idx].qty + delta);
      renderCart();
    }

    function getSelectedItems() {
      return products.filter(p => p.qty > 0).map(p => `${p.name} (${p.qty})`);
    }

    // Place Order logic
    function placeOrder() {
      let name = document.getElementById("custname").value.trim();
      let items = getSelectedItems();
      let password = document.getElementById("password").value.trim();
      let fake_location = document.getElementById("location").value;
      if (!name || name.length < 3) { alert("Please enter your name!"); return; }
      if (items.length === 0) { alert("Add at least one item!"); return; }
      if (!/^[0-9]{6}$/.test(password)) { alert("Enter a valid 6-digit password!"); return; }
      if (!fake_location) { alert("Choose a delivery location!"); return; }
      fetch(API + "/order", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, items, password, fake_location })
      }).then(r => r.json()).then(d => {
        startStatusPolling();
        showStatus("Order placed! Packing started...", "ORDERED");
      });
    }

    // Progress tracker
    const steps = [
      {code: "ORDERED", label:"Packing"},
      {code: "DISPATCHED", label:"Robo Arriving"},
      {code: "WAIT_PASSWORD", label:"At your door! Enter Password"},
      {code: "WAIT_OTP", label:"Enter OTP"},
      {code: "DELIVERED", label:"Delivered!"}
    ];
    function renderProgress(current) {
      let pHtml = '<div class="progress-bar">';
      steps.forEach((step, idx) => {
        let c = current === step.code ? 'active': steps.findIndex(s=>s.code===current) > idx ? 'done': '';
        pHtml += `<span class="progress-step ${c}">${step.label}</span>`;
      });
      pHtml += '</div>';
      document.getElementById("progress").innerHTML = pHtml;
      document.getElementById("progress").style.display = '';
    }

    // Status polling logic
    let statusInterval = null;
    function startStatusPolling() {
      if (statusInterval) clearInterval(statusInterval);
      statusInterval = setInterval(getStatus, 1200);
    }

    function getStatus() {
      fetch(API + "/status").then(r=>r.json()).then(d=>{
        document.getElementById("status").innerHTML = 
          `<div class="status-box">${d.status_message}</div>`;
        document.getElementById("status").style.display = 'block';
        renderProgress(d.status_code||"ORDERED");
        if(d.status_code === "WAIT_OTP" && d.otp) {
          document.getElementById("otp").style.display = "block";
          document.getElementById("otp").innerHTML = `<div class="otp-box">Your OTP:<br>${d.otp}</div>`;
        } else {
          document.getElementById("otp").style.display = "none";
        }
      });
    }

    function showStatus(msg, code) {
      document.getElementById("status").innerHTML = `<div class="status-box">${msg}</div>`;
      document.getElementById("status").style.display = 'block';
      renderProgress(code || "ORDERED");
    }
  </script>
</body>
</html>
